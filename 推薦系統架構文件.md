# 寵物應用推薦系統架構文件

## 概述

本專案實現了一個完整的推薦系統，支援**疾病檔案推薦**和**社群貼文推薦**兩大功能模組。系統採用基於深度學習的語意相似度匹配技術，結合用戶行為歷史，提供個性化的內容推薦。

## 系統架構

### 1. 核心技術棧

- **深度學習模型**: BERT-based Chinese (`ckiplab/bert-base-chinese`)
- **向量相似度檢索**: FAISS (Facebook AI Similarity Search)
- **語言處理**: Transformers (HuggingFace)
- **向量運算**: NumPy
- **深度學習框架**: PyTorch
- **後端框架**: Django REST Framework

### 2. 系統組件

```
推薦系統
├── 推薦服務核心 (RecommendationService)
│   ├── 向量化引擎 (BERT Embeddings)
│   ├── 相似度檢索 (FAISS Index)
│   └── 用戶行為建模
├── 疾病檔案推薦 API
└── 社群貼文推薦 API
```

## 推薦系統核心實現

### RecommendationService 類別

位置: `backend/utils/recommendation_service.py`

#### 初始化流程

1. **環境配置**
   ```python
   # 解決 OpenMP 衝突
   os.environ["KMP_DUPLICATE_LIB_OK"] = "TRUE"
   os.environ["OMP_NUM_THREADS"] = "1"
   ```

2. **模型載入**
   ```python
   # 支援 GPU 和 CPU 兩種模式
   self.device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
   self.tokenizer = AutoTokenizer.from_pretrained("ckiplab/bert-base-chinese")
   self.model = AutoModel.from_pretrained("ckiplab/bert-base-chinese").eval().to(self.device)
   ```

3. **數據初始化**
   - 自動從資料庫載入社群貼文 (SoLContent) 和疾病檔案 (DiseaseArchiveContent)
   - 生成向量表示並建立 FAISS 索引
   - 支援增量更新和刪除

#### 關鍵方法

##### 1. 內容向量化 (`__mean_pooling`)
```python
def __mean_pooling(self, outputs, mask):
    token_embeddings = outputs.last_hidden_state
    mask = mask.unsqueeze(-1).float()
    summed = (token_embeddings * mask).sum(1)
    counts = mask.sum(1).clamp(min=1e-9)
    return summed / counts
```

##### 2. 用戶歷史建模 (`embed_user_history`)
- **時間衰減機制**: 使用指數衰減函數處理時間影響
- **行為權重**: 不同行為賦予不同權重
  - `liked`: 1.0
  - `comment`: 1.5
  - `share`: 2.0

```python
# 時間衰減計算
age_hours = (now - ts) / 3600.0
w = ACTION_WEIGHTS.get(action, 1.0) * math.exp(-decay_lambda_per_hour * age_hours)
```

##### 3. 推薦生成 (`recommend_posts`)
- 使用 FAISS IndexFlatIP 進行內積相似度搜尋
- 支援內容類型過濾 (`social`, `disease`)
- 返回結構化結果包含原始ID和內容類型

### 向量存儲機制

- **向量文件**: `post_embs.npy` (768維BERT向量)
- **ID映射**: `post_ids.npy` (格式: `{content_type}_{original_id}`)
- **類型標記**: `post_content_types.npy` (內容類型標識)

## 疾病檔案推薦系統

### API 端點
`GET /pets/disease-archives/recommended/`

### 功能特點

#### 1. 多種推薦策略
- **個性化推薦** (`sort=recommendation`): 基於用戶行為歷史
- **最新排序** (`sort=latest`): 按創建時間倒序
- **熱門排序** (`sort=popular`): 按互動數量排序

#### 2. 用戶行為收集 (`_collect_disease_interaction_history`)
收集以下互動類型:
- 點讚、收藏、分享等基本互動 (UserInteraction)
- 評論互動 (Comment)
- 只處理公開的疾病檔案 (`is_private=False`)

#### 3. 推薦流程
```python
# 1. 收集用戶歷史
history = self._collect_disease_interaction_history(request.user)

# 2. 如果無歷史，返回最新檔案
if not history:
    return self._get_latest_archives_with_pagination(...)

# 3. 向量化用戶偏好
embedded_history = recommendation_service.embed_user_history(...)

# 4. 獲取推薦結果
search_results = recommendation_service.recommend_posts(
    embedded_history,
    content_type_filter="disease"
)
```

#### 4. 分頁和過濾
- 支援 `limit` (1-50) 和 `offset` 參數
- 自動過濾用戶已互動的內容
- 智能降級: 推薦系統失敗時自動切換到最新排序

## 社群貼文推薦系統

### API 實現
位置: `backend/social/views.py` - `RecommendedPostListAPIView`

### 核心特點

#### 1. 即時向量更新
- **新增貼文**: 自動生成向量並加入索引
- **刪除貼文**: 從向量庫中移除對應記錄
- **編輯貼文**: 重新生成向量並更新

```python
# 新增貼文時
recommendation_service.embed_new_post(postFrame.id, content, "social")

# 刪除貼文時
recommendation_service.delete_post_data(postFrame.id, "social")
```

#### 2. 用戶行為追蹤
收集多種互動行為:
- 基本互動 (UserInteraction): 點讚、收藏、分享
- 評論互動 (Comment)
- 只推薦社群貼文 (`content_type_filter="social"`)

#### 3. 推薦演算法
```python
def get_queryset(self):
    # 1. 收集用戶互動歷史
    history = self._collect_user_interaction_history()
    
    # 2. 無歷史則返回最新貼文
    if not history:
        return PostFrame.objects.filter(contents__isnull=False).order_by('-created_at')
    
    # 3. 獲取推薦結果
    embedded_history = recommendation_service.embed_user_history(...)
    search_results = recommendation_service.recommend_posts(
        embedded_history, 
        top_k=100+len(seen_ids),
        content_type_filter="social"
    )
    
    # 4. 過濾已互動內容
    recommend_list = [result['original_id'] for result in search_results 
                     if result['original_id'] not in seen_ids]
    
    return PostFrame.get_postFrames(idList=recommend_list)
```

## 性能優化策略

### 1. 批次處理
- 向量化時使用批次處理 (`BATCH_SIZE = 4`)
- 支援批量圖片上傳和處理

### 2. 設備自適應
- 自動檢測 CUDA 可用性
- CPU/GPU 自動切換，確保系統兼容性

### 3. 記憶體管理
- 使用 `torch.no_grad()` 減少記憶體佔用
- 向量正規化節省存儲空間

### 4. 索引優化
- FAISS IndexFlatIP 提供高效相似度檢索
- 內積計算優化向量匹配速度

## 容錯機制

### 1. 多層降級策略
```python
try:
    # 嘗試個性化推薦
    return personalized_recommendations()
except RecommendationError:
    # 降級到最新內容
    return latest_content()
```

### 2. 異常處理
- 推薦系統故障時自動切換到時間排序
- 詳細的錯誤日誌記錄
- 用戶無感的服務降級

### 3. 數據驗證
- 向量維度檢查
- ID格式驗證
- 內容類型校驗

## 資料結構

### 推薦結果格式
```json
{
  "code": 200,
  "message": "獲取推薦成功",
  "success": true,
  "data": {
    "archives": [...],  // 或 "posts": [...]
    "has_more": false,
    "total_count": 10,
    "recommendation_type": "personalized|latest|popular",
    "offset": 0,
    "limit": 10
  }
}
```

### 向量存儲結構
```python
{
    "post_ids": ["social_123", "disease_456", ...],
    "post_embeddings": np.array([[768-dim vector], ...]),
    "post_content_types": ["social", "disease", ...]
}
```

## 系統配置

### 超參數設置
```python
BATCH_SIZE = 4                    # 批次處理大小
ACTION_WEIGHTS = {                # 行為權重
    "liked": 1.0,
    "comment": 1.5, 
    "share": 2.0
}
decay_lambda_per_hour = 0.1       # 時間衰減率
```

### 模型配置
- **模型**: `ckiplab/bert-base-chinese`
- **向量維度**: 768
- **最大序列長度**: 512 (BERT預設)
- **相似度度量**: 內積 (Inner Product)

## 未來擴展方向

### 1. 演算法優化
- 引入更複雜的用戶畫像建模
- 加入協同過濾機制
- 實現多目標優化推薦

### 2. 功能擴展
- 支援實時推薦更新
- 加入推薦解釋機制
- 實現A/B測試框架

### 3. 性能提升
- 引入分散式向量檢索
- 實現增量模型更新
- 加入推薦結果快取機制

## 總結

本推薦系統成功整合了現代深度學習技術與傳統推薦演算法，實現了高效、準確的個性化內容推薦。系統具備良好的擴展性和容錯性，能夠適應不同規模的數據和用戶需求。通過持續的優化和改進，系統將為用戶提供更好的內容發現體驗。