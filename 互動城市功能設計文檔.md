# 互動城市功能設計文檔

## 一、功能概述

互動城市是一個結合實體地圖與虛擬獎勵的功能，主要目的是鼓勵使用者帶寵物出門散步。透過設置站點、任務系統、金幣獎勵和競標機制，創造一個有趣且具社交性的寵物散步體驗。

### 核心理念
- **鼓勵外出**：透過任務引導使用者定期帶寵物散步
- **真實定位**：使用GPS定位確保使用者實際到達指定地點
- **社交互動**：透過競標展示寵物照片，增加社群互動
- **獎勵機制**：完成任務獲得金幣，創造持續參與的動機

## 二、主要功能模組

### 2.1 站點系統（Checkpoints）

#### 功能描述
- 開發者在城市地圖上預設多個站點
- 每個站點有精確的經緯度座標
- 站點在地圖上以特定圖示顯示
- 使用者接近站點時可點擊進入內部場景

#### 站點屬性
```javascript
// 後端資料
{
  id: string,                    // 站點唯一識別碼
  name: string,                   // 站點名稱
  description: string,            // 站點描述
  coordinates: {
    latitude: number,             // 緯度
    longitude: number             // 經度
  },
  radius: number,                 // 有效簽到範圍（公尺）
  baseBidPrice: number,          // 競標起標價（金幣）
  totalCheckins: number,         // 總簽到次數
  popularityScore: number,       // 熱門度分數
  currentOwner: {                // 當前展示權擁有者
    userId: string,
    petImage: string,
    expiryDate: Date
  }
}

// 前端顯示配置（存於前端代碼）
{
  checkpointId: string,          // 對應的站點ID
  modelType: string,             // 3D模型類型（對應GLB檔案）
  sceneConfig: {                 // Three.js場景配置
    lighting: object,            // 光照設定
    materials: object,           // 材質參數
    animations: array,           // 動畫配置
    camera: object,              // 相機設定
    environment: object          // 環境設定
  }
}
```

### 2.2 任務系統（Daily Missions）

#### 功能描述
- 每天自動生成個人化任務
- 任務要求經過特定數量的站點
- 可選擇不同難度的任務（站點數量不同）

#### 任務類型
1. **每日任務**
   - 簡單：經過2個站點（獎勵：10金幣）
   - 中等：經過4個站點（獎勵：25金幣）
   - 困難：經過6個站點（獎勵：50金幣）

2. **路線挑戰**
   - 預設的散步路線
   - 需按順序經過指定站點
   - 完成獎勵更豐厚（80-150金幣）

#### 任務數據結構
```javascript
{
  id: string,                    // 任務ID
  userId: string,                // 使用者ID
  type: 'daily' | 'route',       // 任務類型
  status: 'active' | 'completed' | 'expired',
  checkpoints: [string],         // 需要經過的站點ID列表
  completedCheckpoints: [string], // 已完成的站點
  reward: number,                // 金幣獎勵
  createdAt: Date,
  expiresAt: Date
}
```

### 2.3 簽到系統（Check-in）

#### 功能流程
1. 使用者接近站點（距離 < 50公尺）
2. 地圖上站點圖示變為可互動狀態
3. 點擊站點進入內部場景
4. 顯示站點資訊和當前展示的寵物照片
5. 點擊簽到按鈕完成簽到
6. 更新任務進度

#### 簽到驗證
- GPS定位驗證（經緯度誤差範圍）
- 時間間隔限制（同一站點每日限簽到一次）
- 防作弊機制（移動速度檢測）

### 2.4 金幣系統（Coins）

#### 獲得方式
- 完成每日任務
- 完成路線挑戰
- 連續簽到獎勵
- 特殊活動獎勵

#### 使用途徑
- 競標站點展示權
- 未來可擴展：購買虛擬道具、解鎖特殊功能

#### 金幣記錄
```javascript
{
  userId: string,
  balance: number,               // 當前餘額
  transactions: [{
    id: string,
    type: 'earn' | 'spend',
    amount: number,
    reason: string,              // 任務完成/競標支出等
    timestamp: Date
  }]
}
```

### 2.5 競標系統（Auction）

#### 功能描述
- 使用者可用金幣競標站點的展示權
- 展示權有時效性（如：7天）
- 競標成功後可上傳寵物照片展示

#### 競標規則
1. **競標週期**：每週一次
2. **起標價**：根據站點熱門程度動態調整
3. **最高價得標**：週期結束時出價最高者獲得展示權
4. **展示期限**：7天
5. **自動續約**：可選擇自動續約（需預留金幣）

#### 競標數據結構
```javascript
{
  auctionId: string,
  checkpointId: string,
  startDate: Date,
  endDate: Date,
  minBid: number,                // 起標價
  currentBid: {
    userId: string,
    amount: number,
    timestamp: Date
  },
  bidHistory: [{
    userId: string,
    amount: number,
    timestamp: Date
  }],
  winner: string                 // 得標者ID
}
```

## 三、技術架構

### 3.1 前端技術
- **地圖服務**：Mapbox GL JS
- **定位服務**：HTML5 Geolocation API
- **框架**：React
- **狀態管理**：Context API
- **3D渲染引擎**：Three.js
- **3D模型格式**：GLB（GLTF Binary）
- **3D模型內容**：
  - 哈士奇/柴犬寵物模型
  - 站點建築/地標模型
  - 互動元素模型

### 3.2 後端技術
- **框架**：Django REST Framework
- **數據庫**：SQLite/PostgreSQL
- **定位驗證**：GeoDjango
- **即時通訊**：WebSocket（競標即時更新）

### 3.3 API 端點設計

#### 站點相關
- `GET /api/checkpoints/` - 獲取所有站點
- `GET /api/checkpoints/{id}/` - 獲取站點詳情
- `POST /api/checkpoints/{id}/checkin/` - 簽到

#### 任務相關
- `GET /api/missions/daily/` - 獲取每日任務
- `GET /api/missions/routes/` - 獲取路線列表
- `POST /api/missions/{id}/complete/` - 完成任務

#### 金幣相關
- `GET /api/coins/balance/` - 獲取金幣餘額
- `GET /api/coins/transactions/` - 獲取交易記錄

#### 競標相關
- `GET /api/auctions/active/` - 獲取進行中的競標
- `POST /api/auctions/{id}/bid/` - 出價
- `GET /api/auctions/my-wins/` - 我的得標記錄
- `POST /api/checkpoints/{id}/upload-pet/` - 上傳展示照片

## 四、用戶體驗流程

### 4.1 新手引導流程
1. 首次進入互動城市
2. 教學說明基本操作
3. 引導完成第一個簽到
4. 獲得新手獎勵金幣
5. 介紹任務和競標系統

### 4.2 日常使用流程
1. 進入互動城市查看每日任務
2. 規劃散步路線
3. 帶寵物出門散步
4. 到達站點進行簽到
5. 完成任務獲得金幣
6. 參與站點競標
7. 上傳寵物照片展示

### 4.3 社交互動流程
1. 在站點看到其他人的寵物照片
2. 可為喜歡的照片點讚
3. 查看熱門站點排行
4. 分享散步成就

## 五、資料庫設計

### 5.1 主要數據表

#### Checkpoints（站點表）
- id (PK)
- name
- description
- latitude
- longitude
- radius
- base_bid_price (競標起標價)
- total_checkins (總簽到次數)
- popularity_score (熱門度分數)
- status (狀態)
- created_at
- updated_at

#### Missions（任務表）
- id (PK)
- user_id (FK)
- type
- status
- reward_amount
- created_at
- expires_at
- completed_at

#### CheckIns（簽到記錄表）
- id (PK)
- user_id (FK)
- checkpoint_id (FK)
- mission_id (FK)
- timestamp
- location_accuracy

#### CoinTransactions（金幣交易表）
- id (PK)
- user_id (FK)
- type
- amount
- balance_after
- reason
- reference_id
- created_at

#### Auctions（競標表）
- id (PK)
- checkpoint_id (FK)
- start_date
- end_date
- min_bid
- current_bid_amount
- current_bidder_id (FK)
- winner_id (FK)
- status

#### DisplayRights（展示權表）
- id (PK)
- checkpoint_id (FK)
- user_id (FK)
- pet_image_url
- start_date
- end_date
- acquired_through (auction/special)

## 六、安全性考量

### 6.1 防作弊措施
- GPS位置驗證（服務端驗證）
- 移動速度檢測（防止位置偽造）
- 簽到時間間隔限制
- IP地址記錄和分析
- 異常行為檢測

### 6.2 隱私保護
- 位置資訊僅用於功能需要
- 不儲存完整移動軌跡
- 使用者可選擇隱藏個人資訊
- 遵循GDPR等隱私法規

## 七、未來擴展

### 7.1 功能擴展
- **寵物互動**：在站點遇到其他寵物可互動
- **成就系統**：解鎖各種成就徽章
- **排行榜**：每週/每月散步排行
- **團隊挑戰**：多人組隊完成路線
- **季節活動**：節日特殊任務和獎勵

### 7.2 商業化可能
- **贊助站點**：商家贊助特定站點
- **優惠券**：完成任務獲得實體店家優惠
- **付費道具**：購買特殊展示效果
- **VIP會員**：提供額外任務和獎勵

## 八、效能優化

### 8.1 前端優化
- 地圖圖層懶加載
- 站點資訊快取
- 圖片壓縮和CDN
- 離線功能支援

### 8.2 後端優化
- 位置索引優化（空間索引）
- 熱門站點快取
- 任務生成演算法優化
- 資料庫查詢優化

### 8.3 3D渲染優化
- GLB模型檔案壓縮和優化
- 材質和紋理壓縮
- LOD（Level of Detail）系統
- 模型實例化重用
- 動畫系統優化
- 場景遮擋剔除

## 八之二、3D技術實作詳細規劃（前端實作）

### 前端模型管理系統
- **模型檔案組織**：
  ```
  /public/assets/models/checkpoints/
    ├── default_checkpoint.glb
    ├── landmark_park.glb
    ├── landmark_building.glb
    ├── landmark_statue.glb
    └── interactive_fountain.glb
  ```

- **站點配置映射檔（前端）**：
  ```javascript
  // checkpointConfigs.js
  export const checkpointConfigs = {
    'checkpoint-id-1': {
      modelType: 'landmark_park',
      sceneConfig: { /* Three.js配置 */ }
    },
    'checkpoint-id-2': {
      modelType: 'landmark_building',
      sceneConfig: { /* Three.js配置 */ }
    }
    // ...
  }
  ```

### Three.js場景配置範例（前端實作）
```javascript
{
  "lighting": {
    "ambient": {
      "color": "#ffffff",
      "intensity": 0.6
    },
    "directional": {
      "color": "#ffffff", 
      "intensity": 1.0,
      "position": [10, 10, 5]
    }
  },
  "materials": {
    "roughness": 0.4,
    "metalness": 0.1,
    "envMapIntensity": 1.0
  },
  "animations": [
    {
      "name": "idle",
      "loop": true,
      "speed": 1.0
    }
  ],
  "camera": {
    "position": [0, 2, 5],
    "target": [0, 0, 0],
    "fov": 60
  },
  "environment": {
    "background": "sky",
    "fog": {
      "enabled": true,
      "color": "#cccccc",
      "near": 10,
      "far": 100
    }
  }
}
```

### 前端模型載入流程
1. 從後端API獲取站點基本資料（ID、座標、名稱等）
2. 根據站點ID查詢前端配置檔獲取對應的 `modelType` 和 `sceneConfig`
3. 根據 `modelType` 載入對應的GLB檔案
4. 使用Three.js GLTFLoader載入模型
5. 套用 `sceneConfig` 中的配置參數
6. 渲染到站點內部場景
7. 從後端獲取並載入當前展示的寵物照片

## 九、監控與分析

### 9.1 關鍵指標
- 日活躍用戶數（DAU）
- 平均散步時長
- 任務完成率
- 金幣流通量
- 競標參與率

### 9.2 用戶行為分析
- 熱門站點分析
- 散步路線偏好
- 活躍時段分布
- 用戶留存率

## 十、開發階段規劃

### Phase 1：基礎功能（第1-2週）
- [ ] 地圖顯示和定位
- [ ] 站點系統基礎
- [ ] 簽到功能
- [ ] 基礎任務系統

### Phase 2：核心功能（第3-4週）
- [ ] 金幣系統
- [ ] 每日任務生成
- [ ] 路線挑戰
- [ ] 任務完成驗證

### Phase 3：社交功能（第5-6週）
- [ ] 競標系統
- [ ] 照片上傳展示
- [ ] 社交互動（點讚）
- [ ] 排行榜

### Phase 4：優化完善（第7-8週）
- [ ] 效能優化
- [ ] 防作弊完善
- [ ] 用戶體驗優化
- [ ] 測試和修復

---

**文檔版本**：1.0.0  
**更新日期**：2025-01-23  
**作者**：PetApp 開發團隊